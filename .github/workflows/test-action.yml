name: Test Action

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test-action-default:
    runs-on: ubuntu-latest
    name: Test action with defaults

    steps:
      - name: Start BACnet Simulator
        uses: rise-building-technology/bacnet-sim-ci@main
        id: sim

      - name: Verify outputs
        run: |
          echo "API URL: ${{ steps.sim.outputs.api-url }}"
          echo "BACnet Port: ${{ steps.sim.outputs.bacnet-port }}"

      - name: Verify health
        run: |
          curl -sf http://localhost:8099/health/ready | python3 -m json.tool

      - name: Verify devices
        run: |
          DEVICES=$(curl -sf http://localhost:8099/api/devices)
          echo "$DEVICES" | python3 -m json.tool

          COUNT=$(echo "$DEVICES" | python3 -c "import sys,json; print(len(json.load(sys.stdin)))")
          test "$COUNT" -ge 1 && echo "PASS: $COUNT device(s) found" || { echo "FAIL: no devices"; exit 1; }

      - name: Verify read object
        run: |
          DEVICE_ID=$(curl -sf http://localhost:8099/api/devices | python3 -c "import sys,json; print(json.load(sys.stdin)[0]['deviceId'])")
          RESP=$(curl -sf "http://localhost:8099/api/devices/$DEVICE_ID/objects/analog-input/1")
          echo "$RESP" | python3 -m json.tool

          NAME=$(echo "$RESP" | python3 -c "import sys,json; print(json.load(sys.stdin)['name'])")
          test "$NAME" = "Zone Temp" && echo "PASS: Read object verified" || { echo "FAIL: got $NAME"; exit 1; }

      - name: Verify write and read back
        run: |
          DEVICE_ID=$(curl -sf http://localhost:8099/api/devices | python3 -c "import sys,json; print(json.load(sys.stdin)[0]['deviceId'])")

          curl -sf -X PUT \
            "http://localhost:8099/api/devices/$DEVICE_ID/objects/analog-output/1" \
            -H "Content-Type: application/json" \
            -d '{"value": 99.9}'

          VALUE=$(curl -sf "http://localhost:8099/api/devices/$DEVICE_ID/objects/analog-output/1" | python3 -c "import sys,json; print(json.load(sys.stdin)['presentValue'])")
          test "$VALUE" = "99.9" && echo "PASS: Write/read verified" || { echo "FAIL: got $VALUE"; exit 1; }

      - name: Cleanup
        if: always()
        run: docker rm -f bacnet-sim 2>/dev/null || true

  test-action-multi-device:
    runs-on: ubuntu-latest
    name: Test action with 9-device config

    steps:
      - name: Checkout test repo
        uses: actions/checkout@v4
        with:
          path: bacnet-sim-ci-test

      - name: Start BACnet Simulator with 9-device config
        uses: rise-building-technology/bacnet-sim-ci@main
        id: sim
        with:
          config-file: bacnet-sim-ci-test/config/nine-devices.yaml

      - name: Verify 9 devices running
        run: |
          DEVICES=$(curl -sf http://localhost:8099/api/devices)
          echo "$DEVICES" | python3 -m json.tool

          COUNT=$(echo "$DEVICES" | python3 -c "import sys,json; print(len(json.load(sys.stdin)))")
          test "$COUNT" -eq 9 && echo "PASS: $COUNT devices found" || { echo "FAIL: expected 9, got $COUNT"; exit 1; }

      - name: Verify device IDs
        run: |
          DEVICE_IDS=$(curl -sf http://localhost:8099/api/devices | python3 -c "
          import sys, json
          ids = sorted(d['deviceId'] for d in json.load(sys.stdin))
          print(' '.join(str(i) for i in ids))
          ")
          EXPECTED="1001 1002 2001 2002 2003 2004 3001 4001 4002"
          test "$DEVICE_IDS" = "$EXPECTED" && echo "PASS: All device IDs match" || { echo "FAIL: got $DEVICE_IDS"; exit 1; }

      - name: Verify AHU template object
        run: |
          RESP=$(curl -sf "http://localhost:8099/api/devices/1001/objects/analog-input/1")
          echo "$RESP" | python3 -m json.tool
          NAME=$(echo "$RESP" | python3 -c "import sys,json; print(json.load(sys.stdin)['name'])")
          test "$NAME" = "Supply Air Temp" && echo "PASS: AHU template verified" || { echo "FAIL: got $NAME"; exit 1; }

      - name: Verify VAV template object
        run: |
          RESP=$(curl -sf "http://localhost:8099/api/devices/2001/objects/analog-input/1")
          NAME=$(echo "$RESP" | python3 -c "import sys,json; print(json.load(sys.stdin)['name'])")
          test "$NAME" = "Zone Temp" && echo "PASS: VAV template verified" || { echo "FAIL: got $NAME"; exit 1; }

      - name: Verify Boiler template object
        run: |
          RESP=$(curl -sf "http://localhost:8099/api/devices/3001/objects/analog-input/1")
          NAME=$(echo "$RESP" | python3 -c "import sys,json; print(json.load(sys.stdin)['name'])")
          test "$NAME" = "Supply Water Temp" && echo "PASS: Boiler template verified" || { echo "FAIL: got $NAME"; exit 1; }

      - name: Verify Meter template object
        run: |
          RESP=$(curl -sf "http://localhost:8099/api/devices/4001/objects/analog-input/1")
          NAME=$(echo "$RESP" | python3 -c "import sys,json; print(json.load(sys.stdin)['name'])")
          test "$NAME" = "Power" && echo "PASS: Meter template verified" || { echo "FAIL: got $NAME"; exit 1; }

      - name: Cleanup
        if: always()
        run: docker rm -f bacnet-sim 2>/dev/null || true

  test-action-custom-inputs:
    runs-on: ubuntu-latest
    name: Test action with custom inputs

    steps:
      - name: Start BACnet Simulator with custom settings
        uses: rise-building-technology/bacnet-sim-ci@main
        id: sim
        with:
          device-id: "2001"
          device-name: "CustomDevice"
          network-profile: "local-network"

      - name: Verify custom device ID
        run: |
          DEVICE_ID=$(curl -sf http://localhost:8099/api/devices | python3 -c "import sys,json; print(json.load(sys.stdin)[0]['deviceId'])")
          test "$DEVICE_ID" = "2001" && echo "PASS: Device ID is 2001" || { echo "FAIL: got $DEVICE_ID"; exit 1; }

      - name: Verify custom device name
        run: |
          NAME=$(curl -sf http://localhost:8099/api/devices | python3 -c "import sys,json; print(json.load(sys.stdin)[0]['name'])")
          test "$NAME" = "CustomDevice" && echo "PASS: Device name is CustomDevice" || { echo "FAIL: got $NAME"; exit 1; }

      - name: Cleanup
        if: always()
        run: docker rm -f bacnet-sim 2>/dev/null || true
