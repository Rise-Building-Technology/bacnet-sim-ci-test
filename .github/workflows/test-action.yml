name: Test Action

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test-action-default:
    runs-on: ubuntu-latest
    name: Test action with defaults

    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Start BACnet Simulator
        uses: rise-building-technology/bacnet-sim-ci@main
        id: sim

      - name: Verify outputs
        run: |
          echo "API URL: ${{ steps.sim.outputs.api-url }}"
          echo "BACnet Port: ${{ steps.sim.outputs.bacnet-port }}"

      - name: Verify health
        run: |
          curl -sf http://localhost:8099/health/ready | python3 -m json.tool

      - name: Verify devices
        run: |
          DEVICES=$(curl -sf http://localhost:8099/api/devices)
          echo "$DEVICES" | python3 -m json.tool

          COUNT=$(echo "$DEVICES" | python3 -c "import sys,json; print(len(json.load(sys.stdin)))")
          test "$COUNT" -ge 1 && echo "PASS: $COUNT device(s) found" || { echo "FAIL: no devices"; exit 1; }

      - name: Verify read object
        run: |
          DEVICE_ID=$(curl -sf http://localhost:8099/api/devices | python3 -c "import sys,json; print(json.load(sys.stdin)[0]['deviceId'])")
          RESP=$(curl -sf "http://localhost:8099/api/devices/$DEVICE_ID/objects/analog-input/1")
          echo "$RESP" | python3 -m json.tool

          NAME=$(echo "$RESP" | python3 -c "import sys,json; print(json.load(sys.stdin)['name'])")
          test "$NAME" = "Zone Temp" && echo "PASS: Read object verified" || { echo "FAIL: got $NAME"; exit 1; }

      - name: Verify write and read back
        run: |
          DEVICE_ID=$(curl -sf http://localhost:8099/api/devices | python3 -c "import sys,json; print(json.load(sys.stdin)[0]['deviceId'])")

          curl -sf -X PUT \
            "http://localhost:8099/api/devices/$DEVICE_ID/objects/analog-output/1" \
            -H "Content-Type: application/json" \
            -d '{"value": 99.9}'

          VALUE=$(curl -sf "http://localhost:8099/api/devices/$DEVICE_ID/objects/analog-output/1" | python3 -c "import sys,json; print(json.load(sys.stdin)['presentValue'])")
          test "$VALUE" = "99.9" && echo "PASS: Write/read verified" || { echo "FAIL: got $VALUE"; exit 1; }

      - name: Cleanup
        if: always()
        run: docker rm -f bacnet-sim 2>/dev/null || true

  test-action-custom-inputs:
    runs-on: ubuntu-latest
    name: Test action with custom inputs

    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Start BACnet Simulator with custom settings
        uses: rise-building-technology/bacnet-sim-ci@main
        id: sim
        with:
          device-id: "2001"
          device-name: "CustomDevice"
          network-profile: "local-network"

      - name: Verify custom device ID
        run: |
          DEVICE_ID=$(curl -sf http://localhost:8099/api/devices | python3 -c "import sys,json; print(json.load(sys.stdin)[0]['deviceId'])")
          test "$DEVICE_ID" = "2001" && echo "PASS: Device ID is 2001" || { echo "FAIL: got $DEVICE_ID"; exit 1; }

      - name: Verify custom device name
        run: |
          NAME=$(curl -sf http://localhost:8099/api/devices | python3 -c "import sys,json; print(json.load(sys.stdin)[0]['name'])")
          test "$NAME" = "CustomDevice" && echo "PASS: Device name is CustomDevice" || { echo "FAIL: got $NAME"; exit 1; }

      - name: Cleanup
        if: always()
        run: docker rm -f bacnet-sim 2>/dev/null || true
