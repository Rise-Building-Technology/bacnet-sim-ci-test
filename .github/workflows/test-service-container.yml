name: Test Service Container

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test-service-container:
    runs-on: ubuntu-latest

    services:
      bacnet-sim:
        image: ghcr.io/rise-building-technology/bacnet-sim-ci:latest
        credentials:
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}
        ports:
          - 47808:47808/udp
          - 8099:8099
        options: >-
          --cap-add=NET_ADMIN
          --health-cmd "curl -f http://localhost:8099/health/ready || exit 1"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10
          --health-start-period 15s

    steps:
      - name: Wait for simulator to be ready
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8099/health/ready; then
              echo ""
              echo "Simulator is ready!"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "ERROR: Simulator not ready after 30 seconds"
              exit 1
            fi
            sleep 1
          done

      - name: Verify health endpoints
        run: |
          echo "=== Liveness ==="
          curl -sf http://localhost:8099/health/live | python3 -m json.tool

          echo "=== Readiness ==="
          curl -sf http://localhost:8099/health/ready | python3 -m json.tool

      - name: List devices
        run: |
          echo "=== Devices ==="
          curl -sf http://localhost:8099/api/devices | python3 -m json.tool

      - name: Read and write objects
        run: |
          DEVICE_ID=$(curl -sf http://localhost:8099/api/devices | python3 -c "import sys,json; print(json.load(sys.stdin)[0]['deviceId'])")
          echo "Device ID: $DEVICE_ID"

          echo "=== Read Zone Temp ==="
          RESP=$(curl -sf "http://localhost:8099/api/devices/$DEVICE_ID/objects/analog-input/1")
          echo "$RESP" | python3 -m json.tool
          NAME=$(echo "$RESP" | python3 -c "import sys,json; print(json.load(sys.stdin)['name'])")
          test "$NAME" = "Zone Temp" && echo "PASS: Read verified" || { echo "FAIL: got $NAME"; exit 1; }

          echo "=== Write Zone Setpoint ==="
          curl -sf -X PUT \
            "http://localhost:8099/api/devices/$DEVICE_ID/objects/analog-output/1" \
            -H "Content-Type: application/json" \
            -d '{"value": 68.0}' | python3 -m json.tool

          echo "=== Read back ==="
          VALUE=$(curl -sf "http://localhost:8099/api/devices/$DEVICE_ID/objects/analog-output/1" | python3 -c "import sys,json; print(json.load(sys.stdin)['presentValue'])")
          test "$VALUE" = "68.0" && echo "PASS: Write/read verified" || { echo "FAIL: got $VALUE"; exit 1; }

      - name: Update network profile
        run: |
          DEVICE_ID=$(curl -sf http://localhost:8099/api/devices | python3 -c "import sys,json; print(json.load(sys.stdin)[0]['deviceId'])")

          RESP=$(curl -sf -X PUT \
            "http://localhost:8099/api/devices/$DEVICE_ID/network-profile" \
            -H "Content-Type: application/json" \
            -d '{"profile": "remote-site"}')
          echo "$RESP" | python3 -m json.tool

          PROFILE=$(echo "$RESP" | python3 -c "import sys,json; print(json.load(sys.stdin)['networkProfile'])")
          test "$PROFILE" = "remote-site" && echo "PASS: Network profile updated" || { echo "FAIL: got $PROFILE"; exit 1; }
